<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Delivery IRL — Симулятор Курьера</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=99836553-15c4-4c1f-b8ef-791b2d40a781"
        type="text/javascript"></script>
    <style>
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            background-color: #000;
        }

        #pano {
            width: 100%;
            height: 100%;
        }

        #ui-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 280px;
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid #ffcc00;
            border-radius: 15px;
            padding: 15px;
            color: white;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
        }

        .cash {
            color: #00ff00;
            font-weight: bold;
            font-size: 1.2em;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #ffcc00;
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        button:hover:not(:disabled) {
            background: #ffe066;
        }

        button:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
        }

        .photo-box {
            width: 100%;
            height: 120px;
            background: #333;
            border-radius: 8px;
            margin: 5px 0 10px 0;
            overflow: hidden;
            border: 1px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            color: #aaa;
            text-align: center;
        }

        .photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .stats,
        #order-screen {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
    </style>
</head>

<body>
    <div id="pano"></div>
    <div id="ui-overlay">
        <div class="stats">Баланс: <span class="cash"><span id="balance">0</span> ₽</span></div>
        <hr style="border-color: #444; margin: 10px 0;">
        <div id="order-screen" style="display:none;">
            <div id="task-text"><b>Цель:</b> Подойди к подъезду</div>
            <div class="photo-box" id="photo-target"></div>
            <div id="dist-info" style="font-size: 0.9em; color: #ccc; text-align: center;">Расстояние: -- м</div>
            <hr style="border-color: #444; margin: 10px 0;">
            <div><b>Фото-фиксация:</b></div>
            <div style="font-size: 0.8em; color: #aaa;">Фото заказа:</div>
            <div class="photo-box" id="photo-order"></div>
            <div style="font-size: 0.8em; color: #aaa;">Фото подъезда:</div>
            <div class="photo-box" id="photo-entrance"></div>
            <button id="deliver-btn" onclick="finishOrder()" disabled>ДОСТАВИТЬ</button>
        </div>
        <button id="start-btn" onclick="takeOrder()">ВЗЯТЬ ЗАКАЗ</button>
    </div>

    <script type="text/javascript">
        // ОБНОВЛЕНО: Я вернул твой рабочий ключ для Static API.
        // Главное — не забудь разрешить домен arseniy1002.github.io в его настройках!
        const staticApiKey = 'cdaa77e9-4c18-4bc2-bf84-1441b1315ac6';

        let panoramaPlayer;
        let balance = 0;
        let targetCoords = null;

        ymaps.ready(function () {
            // Стартуем на дороге (Тверская улица, Москва)
            const startPos = [55.760507, 37.607182];

            ymaps.panorama.locate(startPos).done(
                function (panoramas) {
                    if (panoramas.length > 0) {
                        panoramaPlayer = new ymaps.panorama.Player('pano', panoramas[0], {
                            controls: ['panoramaName', 'zoom', 'fullscreenControl', 'routeEditor']
                        });
                        panoramaPlayer.events.add('panoramachange', checkDistance);
                    } else {
                        alert('Не удалось найти панораму для стартовой точки. Попробуйте другие координаты.');
                    }
                },
                function (error) {
                    alert('Произошла ошибка при загрузке панорамы: ' + error.message);
                }
            );
        });

        function takeOrder() {
            if (!panoramaPlayer) return;

            const currentPos = panoramaPlayer.getPanorama().getPosition();

            const angle = Math.random() * 2 * Math.PI;
            const distance = 0.001 + Math.random() * 0.0005;
            targetCoords = [
                currentPos[0] + distance * Math.cos(angle),
                currentPos[1] + distance * Math.sin(angle)
            ];

            const miniMapUrl = `https://static-maps.yandex.ru/v1?ll=${targetCoords[1]},${targetCoords[0]}&z=18&l=sat&pt=${targetCoords[1]},${targetCoords[0]},pm2rdm&apikey=${staticApiKey}`;

            // ОБНОВЛЕНО: Добавлен onerror для наглядной обработки ошибки
            document.getElementById('photo-target').innerHTML = `<img src="${miniMapUrl}" alt="Мини-карта цели" onerror="this.parentElement.innerHTML = 'Ошибка загрузки карты.<br>Проверь настройки ключа API в кабинете Яндекса.';">`;

            document.getElementById('photo-order').innerHTML = '<span>Ожидание...</span>';
            document.getElementById('photo-entrance').innerHTML = '<span>Ожидание...</span>';
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('order-screen').style.display = 'block';
            checkDistance();
        }

        function checkDistance() {
            if (!targetCoords || !panoramaPlayer.getPanorama()) return;
            const currentPos = panoramaPlayer.getPanorama().getPosition();
            const deliverButton = document.getElementById('deliver-btn');
            const dist = ymaps.coordSystem.geo.getDistance(currentPos, targetCoords);
            document.getElementById('dist-info').innerText = `Расстояние: ${Math.round(dist)} м`;

            if (dist < 15) {
                deliverButton.disabled = false;
                deliverButton.style.background = '#00ff00';
                deliverButton.innerText = 'ДОСТАВИТЬ';
            } else {
                deliverButton.disabled = true;
                deliverButton.style.background = '';
                deliverButton.innerText = 'ПОДОЙДИТЕ БЛИЖЕ';
            }
        }

        function finishOrder() {
            const reward = Math.floor(150 + Math.random() * 350);
            balance += reward;
            document.getElementById('balance').innerText = balance;
            const currentPos = panoramaPlayer.getPanorama().getPosition();

            const entrancePhotoUrl = `https://static-maps.yandex.ru/v1?ll=${currentPos[1]},${currentPos[0]}&z=19&l=sat,skl&pt=${currentPos[1]},${currentPos[0]},pm2gnm&apikey=${staticApiKey}`;

            // ОБНОВЛЕНО: Добавлен onerror для наглядной обработки ошибки
            document.getElementById('photo-entrance').innerHTML = `<img src="${entrancePhotoUrl}" alt="Фото подъезда" onerror="this.parentElement.innerHTML = 'Ошибка загрузки фото.';">`;
            document.getElementById('photo-order').innerHTML = `<span>Доставлено</span>`;

            alert(`Заказ доставлен! +${reward}₽`);
            targetCoords = null;
            setTimeout(() => {
                document.getElementById('start-btn').style.display = 'block';
                document.getElementById('order-screen').style.display = 'none';
                document.getElementById('deliver-btn').innerText = 'ДОСТАВИТЬ';
                document.getElementById('deliver-btn').style.background = '';
            }, 2000);
        }
    </script>
</body>

</html>